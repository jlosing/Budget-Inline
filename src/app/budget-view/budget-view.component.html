<div class="container">
  <h2 class="text-center">My Budget</h2>

  @if (userBudget?.budgetId) {
  <p>Budget ID: {{ userBudget?.budgetId }}</p>
  } @if (userBudget?.name) {
  <p>Budget Name: {{ userBudget?.name }}</p>
  } @if (userBudget?.uid) {
  <p>User ID (owner): {{ userBudget?.uid }}</p>
  } @if (userBudget && userBudget.categories) {
  <h4>Budget Categories:</h4>
  <ul class="list-group d-inline-flex">
    @for (categoryItem of (userBudget.categories | keyvalue); track
    categoryItem.key) {
    <li class="list-group-item">
      <div class="d-flex justify-content-between align-items-center">
        <span>
          {{ categoryItem.key }}:
          {{ categoryItem.value | currency}}
        </span>
        <div>
          <button class="btn btn-sm btn-outline-secondary me-2" (click)="openEditCategoryModal(categoryItem.key, categoryItem.value)">
            Edit Category
          </button>
          <button
            class="btn btn-sm btn-success me-2"
            (click)="openAddTransactionModal(categoryItem.key)"
          >
            + Add Transaction
          </button>
          <button
            class="btn btn-sm btn-outline-danger"
            (click)="confirmDeleteCategory(categoryItem.key)"
          >
            Delete
          </button>
        </div>
      </div>
      @if (showEditCategoryModal) {
      <div class="modal-overlay" (click)="closeEditCategoryModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <button class="btn-close-modal" (click)="closeEditCategoryModal()">
            X
          </button>
          <h5>Edit Category: {{ editingCategory?.oldName }}</h5>
          <div class="mb-3">
            <label for="newCategoryName" class="form-label"
              >New Category Name:</label
            >
            <input
              type="text"
              id="newCategoryName"
              class="form-control"
              [(ngModel)]="newCategoryNameInput"
            />
          </div>
          <div class="mb-3">
            <label for="newCategoryAmount" class="form-label"
              >New Category Amount:</label
            >
            <input
              type="number"
              id="newCategoryAmount"
              class="form-control"
              [(ngModel)]="newCategoryAmountInput"
            />
          </div>
          <button class="btn btn-primary" (click)="submitEditCategory()">
            Save Changes
          </button>
        </div>
      </div>
      }

      <div class="mt-2">
        <h5>Transactions for {{ categoryItem.key }}:</h5>
        @if (getTransactionsForCategory(categoryItem.key).length > 0) { @for
        (transaction of getTransactionsForCategory(categoryItem.key); track
        transaction.id) {
        <div class="card my-1 p-2">
          <p class="mb-0"><strong>Name:</strong> {{ transaction.name }}</p>
          <p class="mb-0">
            <strong>Amount:</strong>
            {{ transaction.amount | currency }}
          </p>
        </div>
        } } @else {
        <p class="text-muted">No transactions for this category yet.</p>
        }
      </div>
    </li>
    } @if (!displayAddCategory) {
    <li class="list-group-item">
      <div class="d-flex justify-content-center align-items-center">
        <button class="btn btn-outline-secondary" (click)="addCategoryClick()">
          Add Category
        </button>
      </div>
    </li>
    } @else {
    <li class="list-group-item">
      <div class="d-flex justify-content-center align-items-center">
        <label for="categoryName" class="form-label">Name:</label>
        <input
          type="text"
          class="form-control"
          id="categoryName"
          [(ngModel)]="categoryName"
        />
        <label for="categoryAmount" class="form-label">Amount</label>
        <input
          type="text"
          class="form-control"
          id="categoryAmount"
          [(ngModel)]="categoryAmount"
        />
        <button class="btn btn-outline-primary" (click)="onClickAdd()">
          Add
        </button>
      </div>
    </li>
    }
  </ul>
  } @else if (userBudget && !userBudget.categories) {
  <p>This budget does not have any specific categories defined.</p>
  } @else if (!userBudget && !isLoadingBudget) {
  <p>No budget found for this user, or budget is still loading.</p>
  } @if (isLoadingBudget) {
  <p>Loading budget...</p>
  } @if (showAddTransactionModal) {
  <div class="modal-overlay" (click)="closeAddTransactionModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button class="btn-close-modal" (click)="closeAddTransactionModal()">
        X
      </button>
      <app-add-transaction
        [inputCategory]="selectedCategoryForNewTransaction"
        [inputId]="userId ?? undefined"
        (transactionAdded)="handleTransactionAdded()"
        (closeModal)="closeAddTransactionModal()"
      >
      </app-add-transaction>
    </div>
  </div>
  }
</div>
